# renQoder PoC 빌드 개선 보고서 v12

## 📅 업데이트 일자
2026-02-07 (12차 개선)

## 🎯 개선 목표
- 인코딩 종료 직전까지 진행률이 3% 등에 머물러 있던 문제를 근본적으로 해결합니다.
- FFmpeg의 표준 로그(`stderr`)와 머신 판독용 로그(`-progress`)를 동시에 활용하여 철통같은 감지 로직을 구축합니다.

---

## ✨ 주요 개선 사항

### 1. `-progress pipe:1` 옵션 및 전용 파서 복구
Windows 환경의 Python `readline()`이 FFmpeg의 표준 진행 로그(캐리지 리턴 `\r` 사용)를 한 줄로 오인하여 버퍼링하던 문제를 해결했습니다.

- **변화**: 머신 판독용인 `-progress` 옵션을 다시 적용하여, 모든 데이터가 강제로 줄바꿈(`\n`)되어 출력되도록 했습니다.
- **파서 강화**: `out_time=HH:MM:SS`, `frame=XXX`, `progress=continue` 등 `key=value` 형태의 모든 시그널을 실시간으로 캐치합니다.

### 2. `total_seconds` & `total_frames` 동시 보정 로직
진행률 계산의 분모가 되는 전체 영상 정보가 누락되지 않도록 `ffprobe` 분석 단계를 강화했습니다.

- **즉시 설정**: `ffprobe` 분석 성공 시 `total_frames`뿐만 아니라 `total_seconds`(Duration)도 즉시 초기화하여, 첫 번째 진행률 패킷부터 즉각 반영되도록 했습니다.
- **안전장치**: 만약 `ffprobe`가 실패하더라도 인코딩 시작 로그에서 `Duration`을 발견하는 즉시 분모 값을 업데이트합니다.

### 3. 하이브리드 로직 (4중 필터링)
1. **`-progress` 시간 기반 (최우선)**
2. **`-progress` 프레임 기반 (차선)**
3. **표준 로그 시간 기반 (폴백 1)**
4. **표준 로그 프레임 기반 (폴백 2)**

어떠한 로그 환경에서도 최소 하나는 걸려들도록 설계되었습니다.

---

## 📝 코드 변경 사항

### 1. `src/renqoder/encoder.py`
- `get_video_info`: 분석 결과에서 Duration과 Frame 정보를 동시에 추출하도록 보완.
- `build_command`: `-progress pipe:1` 옵션 추가.
- `encode`: `key=value` 형태의 데이터 파싱 섹션 추가 및 정규표현식 감지 로직 안정화.

---

## 🧪 테스트 결과

- **진행률 상승 확인**: 로그창에 데이터가 찍힐 때마다 진행바가 1%, 2%, ... 99%, 100%까지 부드럽게 상승함을 확인. ✅
- **완료 시점 일치**: FFmpeg 로그의 마지막 줄(`progress=end`)과 UI의 작업 완료 알림이 정확히 일치함. ✅

---

## 💡 사용자 혜택

- **정확한 정보 제공**: 더 이상 작업이 멈춘 것인지 걱정할 필요가 없습니다. 1초 단위로 갱신되는 정확한 진행률을 보실 수 있습니다.
- **상세한 모니터링**: 하단 로그창을 통해 FFmpeg이 보내는 모든 원본 데이터를 실시간으로 감상(?)하며 작업 상태를 면밀히 체크할 수 있습니다.

---

## 🎉 결론

이번 개선을 통해 **renQoder**는 FFmpeg과의 통신 인터페이스를 가장 안정적인 프로토콜로 전환했습니다. 작업 초기에 진행바가 멈춰있던 현상은 이제 완전히 사라졌습니다. 🚀
