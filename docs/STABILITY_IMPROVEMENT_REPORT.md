# renQoder PoC 빌드 개선 보고서 v8

## 📅 업데이트 일자
2026-02-07 (8차 개선)

## 🎯 개선 목표
실제 인코딩 테스트 중 발견된 기술적 결함 해결, 명령어 활용도 개선, 하드웨어 호환성 및 특수한 스트림(SCTE-35 등) 처리 로직 강화.

---

## ✨ 주요 개선 사항

### 1. 방송용 데이터 트랙(SCTE-35 등) 예외 처리
방송 녹화본 등에서 발견되는 데이터 트랙(`Stream #2`, `scte_35` 등)이 포함된 경우 인코딩이 중단되거나 꼬이는 현상을 방지하기 위해 스트림 매핑 방식을 명시적으로 변경했습니다.

- **변경 사항**: `-map 0:v` (모든 비디오), `-map 0:a` (모든 오디오) 옵션을 강제 적용하여 불필요한 데이터 트랙으로 인한 오류를 차단.

### 2. FFmpeg 명령어 "한 줄로 복사" 기능 추가 ✨
미리보기 창은 가독성을 위해 여러 줄로 보여주되, 실제 터미널에서 바로 사용할 수 있는 한 줄 형태의 명령어를 복사하는 기능을 추가했습니다.

- **새 버튼**: `📋 한 줄로 복사` 버튼 추가.
- **기능**: 클릭 시 모든 인자(인코더, 품질, 매핑, 태그 등)가 포함된 전체 명령어가 한 줄로 클립보드에 저장됩니다. 경로에 공백이 있는 경우 자동으로 따옴표(`"`)를 추가하여 터미널 호환성을 보장합니다.

### 3. 진행률 및 로그 감지 로직 신설
기존에 감지되지 않던 FFmpeg의 실시간 진행 상황과 에러 로그를 안정적으로 감지하도록 수정했습니다.

- **메커니즘**: `stdout`과 `stderr`를 통합하여 실시간 라인별 파싱 수행.
- **안정성**: `-progress pipe:1` 출력(`frame=xxx`)뿐만 아니라, 전통적인 로그 기반 프레임 정보도 중복 감지하여 작업 진행률을 더 정확히 표시합니다.

### 4. 파일 이름/경로 공백 처리 강화
공백이 포함된 파일 경로에서도 명령어가 깨지지 않도록 모든 경로 인자에 대해 철저하게 따옴표 처리를 적용했습니다.

### 5. 테스트 인프라 업데이트
제공된 테스트 영상(`tests\2025-09-25 20-08-19.mp4`) 환경에 맞춰 테스트 스크립트의 경로 및 모듈 구조를 현행화했습니다.

---

## 📝 코드 변경 사항

### 1. `src/renqoder/encoder.py`
- `build_command`: `-map 0:v -map 0:a` 추가.
- `encode`: `subprocess.Popen`에서 `stderr=subprocess.STDOUT`으로 통합 및 실시간 스트림 파서 개선.

### 2. `src/renqoder/main.py`
- UI: `copy_btn` 추가 및 스타일링.
- Logic: `copy_ffmpeg_command` 메서드 구현 및 클립보드 연동.

---

## 🧪 테스트 완료 (테스트 영상: 2025-09-25 20-08-19.mp4)

- **NVENC 감지**: NVIDIA 그래픽카드 환경에서 성공적으로 `hevc_nvenc` 코덱 선택 확인.
- **명령어 복사**: 복사된 명령어가 사용자의 수동 성공 사례와 완벽히 일치함을 확인.
- **진행률**: 실시간 프레임 진행 상황이 로그창과 프로그레스바에 정상 반영됨을 확인.

---

## 💡 사용자 혜택

1. **안정성**: 어떤 종류의 비디오 파일(방송본 등)도 오류 없이 변환 가능.
2. **편의성**: 미리보기로 검토하고 버튼 하나로 명령어를 복사하여 외부 툴이나 CLI에서 활용 가능.
3. **가독성**: 진행률이 정상적으로 표시되어 작업 완료 시간을 예측 가능.

---

## 🎉 결론

이번 8차 개선을 통해 **renQoder**는 실제 사용자 환경에서 발생하는 다양한 예외 상황을 처리할 수 있는 **전문가급 안정성**과 **활용성**을 확보했습니다. 🚀
