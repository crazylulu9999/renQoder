# renQoder PoC 빌드 개선 보고서 v10

## 📅 업데이트 일자
2026-02-07 (10차 개선)

## 🎯 개선 목표
- 사용자의 동의 없는 **무조건적인 파일 덮어쓰기**를 방지하여 데이터를 보호합니다.
- FFmpeg 로그 분석 방식을 개선하여 **진행률이 표시되지 않던 문제**를 근본적으로 해결합니다.

---

## ✨ 주요 개선 사항

### 1. 지능형 덮어쓰기 확인 로직 (Safe Overwrite)
이전 버전의 `-y` (강제 덮어쓰기) 옵션을 제거하고, GUI 레벨에서 먼저 확인하도록 개선했습니다.

- **작동 방식**: 인코딩 시작 버튼 클릭 시, 출력 경로에 이미 파일이 있는지 확인합니다.
- **사용자 인터렉션**: 파일이 존재할 경우 QMessageBox(예/아니오)를 띄워 사용자에게 덮어쓰기 여부를 묻습니다.
- **유연성**: 사용자가 '예'를 선택한 경우에만 `-y` 옵션을 동적으로 추가하여 인코딩을 진행합니다. '아니오'를 선택하면 작업을 안전하게 취소합니다.

### 2. 시간 기반(Duration/Time) 진행률 감지 도입
프레임(`frame=`) 수 파싱에 의존하던 방식에서, 영상의 재생 시간(`time=`)을 기반으로 비율을 계산하는 방식으로 전환했습니다.

- **원리**: 
    1. 인코딩 시작 시 로그에서 `Duration:` (전체 길이)을 추출합니다.
    2. 실시간 로그에서 `time=` (현재 진행 위치)을 캡처합니다.
    3. `(현재 초 / 전체 초) * 100` 공식으로 정확한 퍼센트를 산출합니다.
- **성능**: FFmpeg의 표준 진행 상황 출력 방식과 완벽히 일치하여, 로그창에는 텍스트가 나오는데 진행바가 멈춰있던 현상을 해결했습니다.

### 3. 복합 하이브리드 감지 (Hybrid Progress Detection)
한 가지 방식에 의존하지 않고, 최대한 진행률을 표시하기 위해 다중 레이어 감지 로직을 적용했습니다.

- **1순위 (시간 기반)**: 가장 정확한 `Duration`/`time` 방식을 우선 사용합니다.
- **2순위 (프레임 기반)**: 시간 정보가 부정확하거나 누락된 경우, 기존의 `total_frames`/`frame_num` 방식으로 즉시 폴백(Fallback)합니다.
- **3순위 (로그 감지)**: `.`이나 `,`와 같은 로케일별 구분자 차이까지 정규표현식으로 대응하여 파싱 성공률을 높였습니다.

---

## 📝 코드 변경 사항

### 1. `src/renqoder/encoder.py`
- `build_command`: `overwrite` 매개변수 추가, `-y` 옵션을 조건부로 삽입하도록 수정.
- `encode`: 시간 기반 파싱 로직 및 `convert_to_seconds` 도우미 메서드 추가.
- `get_command_preview`: `overwrite` 상태에 따른 명령어 미리보기 지원.

### 2. `src/renqoder/main.py`
- `start_encoding`: `QMessageBox.question`을 통한 파일 존재 여부 확인 및 조건부 실행 로직 추가.
- `EncoderThread`: 덮어쓰기 승인 여부를 스레드 인자로 전달하도록 확장.

---

## 🧪 테스트 결과

- **덮어쓰기 방지**: 출력 파일이 이미 있을 때 경고창이 정상적으로 뜨고, '아니오' 클릭 시 파일이 보존됨을 확인. ✅
- **진행률 표시**: 사용자가 제공한 팁을 적용한 결과, 인코딩 시작과 동시에 진행률 퍼센트가 정상적으로 갱신됨을 확인. ✅
- **특수 케이스**: `Duration` 정보가 없는 스트리밍 형태의 파일에서도 프레임 기반 폴백을 통해 진행률 표시 시도 확인. ✅

---

## 💡 사용자 혜택

1. **데이터 안전**: 실수로 기존의 중요한 완성본 파일을 덮어쓰는 사고를 예방할 수 있습니다.
2. **시각적 가시성**: 인코딩이 얼마나 남았는지 항상 정확하게 파악할 수 있어 작업 효율이 높아집니다.
3. **높은 호환성**: 다양한 포맷과 환경의 FFmpeg 로그에서도 안정적으로 진행 상황을 추적합니다.

---

## 🎉 결론

이번 10차 개선을 통해 **renQoder**는 사용자의 소중한 데이터를 보호하는 **안전 장치**를 마련함과 동시에, 가장 중요한 UI 요소인 **진행률 표시**를 완벽하게 정상화했습니다. 이제 더욱 신뢰할 수 있는 툴로 거듭났습니다! 🚀
