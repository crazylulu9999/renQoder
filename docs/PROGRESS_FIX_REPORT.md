# renQoder PoC 빌드 개선 보고서 v9

## 📅 업데이트 일자
2026-02-07 (9차 개선)

## 🎯 개선 목표
인코딩 시작 시 발생할 수 있는 사용자 입력 대기(Overwrite prompt 등)를 원천 차단하고, 프레임 수 감지 및 실시간 진행률 표시의 정확성과 성능을 대폭 개선합니다.

---

## ✨ 주요 개선 사항

### 1. 사용자 입력 대기 원천 차단 (Blocking Fix)
출력 경로에 이미 파일이 존재할 경우 FFmpeg이 사용자에게 덮어쓰기 여부(`y/n`)를 묻느라 멈춰버리는 현상을 해결했습니다.

- **강제 덮어쓰기**: 명령어 리스트 처음에 `-y` 옵션을 추가하여 묻지 않고 덮어쓰도록 설정했습니다.
- **입력 채널 폐쇄**: `subprocess.Popen` 실행 시 `stdin=subprocess.DEVNULL`을 명시하여, 어떠한 상황에서도 프로그램이 입력을 기다리며 블로킹되지 않도록 방어했습니다.

### 2. 고속/고성능 프레임 수 감지 (Resilient Detection)
진행률 계산의 기준이 되는 전체 프레임 수(`total_frames`)를 가져오는 로직을 2단계로 고도화했습니다.

- **1단계 (Fast)**: 파일 헤더의 `nb_frames` 정보를 먼저 확인하여 즉시 응답합니다. 만약 정보가 없다면 `duration * fps` 계산을 통해 추정치를 산출합니다.
- **2단계 (Accurate)**: 헤더 정보가 전무한 경우에만 `-count_packets`를 사용하여 전체를 스캔합니다.
- **효과**: 대용량 파일 선택 시 분석 단계에서의 딜레이가 사라지고, 진행률이 표시되지 않는 빈도가 획기적으로 줄어들었습니다.

### 3. 진행률 파싱 로직 강화
FFmpeg의 `-progress pipe:1` 출력 형식을 더 꼼꼼하게 파싱하도록 개선했습니다.

- **포맷 대응**: `frame= 123` (공백 포함) 등 다양한 출력 포맷에 대응하도록 정규식 및 파싱 로직을 보강했습니다.
- **안전성**: 프레임 수를 가져오지 못한 경우에도 인코딩 프로세스 자체는 중단 없이 끝까지 완료되도록 예외 처리를 강화했습니다.

---

## 📝 코드 변경 사항

### 1. `src/renqoder/encoder.py`
- `build_command`: `-y`, `-hide_banner` 옵션 추가.
- `get_video_info`: `nb_frames` 기반의 고속 감지 로직 및 FPS 기반 추정 로직 추가. 타임아웃 튜닝.
- `encode`: `Popen`의 `stdin` 차단 및 출력 파서(`readline`)의 유연성 확보.

---

## 🧪 테스트 결과

- **덮어쓰기 테스트**: 기존 파일이 있는 폴더에서 실행 시 멈춤 없이 즉시 인코딩 시작 확인. ✅
- **진행률 테스트**: 프로그레스바가 시작 직후부터 완료까지 끊김 없이 반영됨을 확인. ✅
- **안정성 테스트**: 헤더 정보가 깨진 파일에서도 추정치를 통해 진행률이 표시됨을 확인. ✅

---

## 💡 사용자 혜택

1. **무중단 작업**: 파일 중복 등 예외 상황에서도 프로그램이 멈추지 않고 계획된 작업을 완료합니다.
2. **빠른 응답**: 파일 선택 직후 분석 단계가 거의 실시간으로 이루어져 쾌적한 사용이 가능합니다.
3. **정확한 진행 상황**: "완료됨"이라고 뜨기 전까지 현재 작업이 몇 % 진행되었는지 정확하게 알 수 있습니다.

---

## 🎉 결론

이번 개선으로 **renQoder**는 실사용 중에 발생할 수 있는 가장 치명적인 문제인 **"무한 대기"** 현상을 해결하였으며, 사용자에게 가장 중요한 피드백인 **"진행 상태 확인"** 기능을 더 빠르고 정확하게 완성했습니다. 🚀
